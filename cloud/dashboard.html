<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mengram ‚Äî Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Cpath d='M60 16 Q92 16 96 48 Q100 78 72 88 Q50 96 38 76 Q26 58 46 46 Q62 38 70 52 Q76 64 62 68' fill='none' stroke='%23a855f7' stroke-width='10' stroke-linecap='round'/%3E%3Ccircle cx='62' cy='68' r='10' fill='%23a855f7'/%3E%3Ccircle cx='62' cy='68' r='4.5' fill='%23fff'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <style>
        :root {
            --bg: #05050a;
            --bg-card: #0a0a14;
            --bg-elevated: #0f0f1a;
            --bg-hover: #13132a;
            --border: #1a1a2e;
            --border-hover: #2a2a44;
            --text: #e8e8f0;
            --text-2: #9898b0;
            --text-3: #5a5a78;
            --accent: #a855f7;
            --accent-dim: rgba(168, 85, 247, 0.12);
            --accent-glow: rgba(168, 85, 247, 0.25);
            --green: #34d399;
            --green-dim: rgba(52, 211, 153, 0.1);
            --blue: #60a5fa;
            --blue-dim: rgba(96, 165, 250, 0.1);
            --orange: #fb923c;
            --orange-dim: rgba(251, 147, 60, 0.1);
            --pink: #f472b6;
            --pink-dim: rgba(244, 114, 182, 0.1);
            --red: #f87171;
            --red-dim: rgba(248, 113, 113, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Sora', sans-serif; -webkit-font-smoothing: antialiased; min-height: 100vh; }

        /* ---- Login ---- */
        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 24px; }
        .login-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 48px 40px; max-width: 420px; width: 100%; text-align: center; }
        .login-box h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .login-box p { color: var(--text-2); font-size: 14px; margin-bottom: 24px; }
        .login-input { width: 100%; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 14px; font-family: 'JetBrains Mono', monospace; outline: none; margin-bottom: 12px; }
        .login-input:focus { border-color: var(--accent); }
        .login-input::placeholder { color: var(--text-3); }
        .login-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; font-family: 'Sora', sans-serif; }
        .login-btn:hover { background: #9333ea; }
        .login-error { color: var(--red); font-size: 13px; margin-top: 12px; display: none; }
        .login-links { margin-top: 20px; font-size: 13px; color: var(--text-3); }
        .login-links a { color: var(--accent); text-decoration: none; }

        /* ---- App Shell ---- */
        .app { display: none; }
        .app.active { display: flex; min-height: 100vh; }

        .sidebar { width: 220px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 20px 0; display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 10; }
        .sidebar-logo { padding: 0 20px 20px; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); margin-bottom: 12px; }
        .sidebar-nav { flex: 1; padding: 8px 10px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 10px; color: var(--text-2); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s; margin-bottom: 2px; }
        .nav-item:hover { background: var(--bg-elevated); color: var(--text); }
        .nav-item.active { background: var(--accent-dim); color: var(--accent); }
        .nav-item .icon { font-size: 16px; width: 20px; text-align: center; }
        .sidebar-footer { padding: 12px 20px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-3); }
        .sidebar-footer a { color: var(--text-2); text-decoration: none; }

        .main { flex: 1; margin-left: 220px; padding: 28px 32px; overflow-y: auto; }

        /* Stats */
        .stats-strip { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 28px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 18px 20px; }
        .stat-label { font-size: 12px; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat-value.purple { color: var(--accent); }
        .stat-value.green { color: var(--green); }
        .stat-value.blue { color: var(--blue); }
        .stat-value.orange { color: var(--orange); }

        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .page-header h2 { font-size: 22px; font-weight: 700; }

        /* Search */
        .search-bar { display: flex; align-items: center; gap: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 8px 14px; width: 280px; position: relative; }
        .search-bar:focus-within { border-color: var(--accent); }
        .search-bar input { background: none; border: none; color: var(--text); font-size: 13px; font-family: 'Sora', sans-serif; outline: none; flex: 1; }
        .search-bar input::placeholder { color: var(--text-3); }
        .search-dropdown { display: none; position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; max-height: 320px; overflow-y: auto; z-index: 100; }
        .search-dropdown.show { display: block; }
        .search-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 13px; }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: var(--bg-hover); }
        .search-item .sname { font-weight: 600; }
        .search-item .sfact { color: var(--text-2); font-size: 12px; margin-top: 2px; }

        /* Tabs */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Feed */
        .feed-list { display: flex; flex-direction: column; gap: 2px; }
        .feed-item { display: flex; gap: 14px; padding: 14px 18px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; align-items: flex-start; transition: all 0.15s; }
        .feed-item:hover { border-color: var(--border-hover); }
        .feed-badge { display: inline-flex; padding: 3px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; white-space: nowrap; min-width: 80px; justify-content: center; }
        .b-person { background: var(--blue-dim); color: var(--blue); }
        .b-project { background: var(--accent-dim); color: var(--accent); }
        .b-technology { background: var(--green-dim); color: var(--green); }
        .b-company { background: var(--orange-dim); color: var(--orange); }
        .b-concept { background: var(--pink-dim); color: var(--pink); }
        .feed-content { flex: 1; }
        .feed-fact { font-size: 14px; line-height: 1.5; }
        .feed-meta { font-size: 11px; color: var(--text-3); margin-top: 4px; }
        .feed-del { opacity: 0; background: none; border: none; color: var(--text-3); cursor: pointer; font-size: 14px; padding: 4px; }
        .feed-item:hover .feed-del { opacity: 1; }
        .feed-del:hover { color: var(--red); }
        .feed-date { font-size: 12px; font-weight: 600; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; padding: 16px 0 6px; }

        /* Empty */
        .empty { text-align: center; padding: 80px 20px; color: var(--text-3); }
        .empty .eicon { font-size: 48px; margin-bottom: 16px; }
        .empty h3 { font-size: 18px; color: var(--text-2); margin-bottom: 8px; }
        .empty p { font-size: 14px; max-width: 400px; margin: 0 auto; line-height: 1.6; }
        .empty a { color: var(--accent); text-decoration: none; }

        /* Graph */
        .graph-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; height: calc(100vh - 200px); position: relative; overflow: hidden; }
        .graph-box svg { width: 100%; height: 100%; }
        .graph-legend { position: absolute; bottom: 16px; left: 16px; display: flex; gap: 14px; font-size: 11px; color: var(--text-2); background: rgba(5,5,10,0.8); padding: 8px 14px; border-radius: 8px; backdrop-filter: blur(8px); }
        .ldot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }

        /* Entities */
        .entities-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
        .e-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 22px 20px; cursor: pointer; transition: all 0.2s; }
        .e-card:hover { border-color: var(--border-hover); transform: translateY(-1px); }
        .e-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .e-name { font-size: 16px; font-weight: 600; }
        .e-tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
        .e-facts { font-size: 13px; color: var(--text-2); line-height: 1.5; }
        .e-count { font-size: 11px; color: var(--text-3); margin-top: 10px; }

        /* Modal */
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 24px; }
        .modal-bg.show { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; max-width: 640px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 32px; }
        .modal-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .modal-head h2 { font-size: 22px; font-weight: 700; }
        .modal-x { background: none; border: none; color: var(--text-3); font-size: 20px; cursor: pointer; }
        .modal-sec { margin-bottom: 20px; }
        .modal-sec h3 { font-size: 13px; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .m-fact { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--bg); border-radius: 8px; margin-bottom: 4px; font-size: 14px; }
        .m-fact button { background: none; border: none; color: var(--text-3); cursor: pointer; opacity: 0; transition: 0.15s; }
        .m-fact:hover button { opacity: 1; }
        .m-fact button:hover { color: var(--red); }
        .m-rel { padding: 6px 12px; background: var(--bg); border-radius: 8px; margin-bottom: 4px; font-size: 13px; color: var(--text-2); }
        .m-rel span { color: var(--accent); font-weight: 500; }
        .m-know { background: var(--bg); border-radius: 10px; padding: 14px; margin-bottom: 8px; }
        .m-know .kt { font-size: 11px; background: var(--accent-dim); color: var(--accent); padding: 2px 8px; border-radius: 4px; font-weight: 600; }
        .m-know .ktitle { font-weight: 600; font-size: 14px; margin-top: 6px; }
        .m-know .kcontent { font-size: 13px; color: var(--text-2); margin-top: 4px; line-height: 1.5; }
        .m-know pre { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; margin-top: 8px; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--green); overflow-x: auto; }
        .m-delete { background: var(--red-dim); color: var(--red); border: 1px solid rgba(248,113,113,0.2); padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Sora', sans-serif; width: 100%; margin-top: 12px; }
        .m-delete:hover { background: rgba(248,113,113,0.15); }

        /* Settings */
        .set-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 24px; margin-bottom: 16px; }
        .set-section h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; }
        .set-section p { font-size: 14px; color: var(--text-2); line-height: 1.5; margin-bottom: 12px; }
        .set-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .set-row:last-child { border-bottom: none; }
        .set-row label { font-size: 14px; }
        .set-row .val { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-2); }
        .btn-s { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Sora', sans-serif; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text); transition: all 0.15s; text-decoration: none; display: inline-block; }
        .btn-s:hover { border-color: var(--border-hover); }
        .btn-d { background: var(--red-dim); color: var(--red); border-color: rgba(248,113,113,0.2); }
        .loading { text-align: center; padding: 40px; color: var(--text-3); }

        /* Insights */
        .insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .insight-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 20px; }
        .insight-card.full { grid-column: 1 / -1; }
        .insight-card .ic-head { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .insight-card .ic-icon { font-size: 24px; }
        .insight-card .ic-title { font-size: 15px; font-weight: 600; }
        .insight-card .ic-scope { font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; padding: 2px 8px; border-radius: 4px; background: var(--accent-dim); color: var(--accent); }
        .insight-card .ic-body { font-size: 14px; color: var(--text-2); line-height: 1.65; }
        .insight-card .ic-meta { margin-top: 12px; font-size: 12px; color: var(--text-3); display: flex; gap: 12px; }
        .insight-card .ic-conf { display: inline-flex; align-items: center; gap: 4px; }
        .insight-card .conf-bar { width: 50px; height: 4px; background: var(--bg-elevated); border-radius: 2px; overflow: hidden; }
        .insight-card .conf-fill { height: 100%; background: var(--green); border-radius: 2px; }
        .insight-empty { text-align: center; padding: 60px 40px; }
        .insight-empty .ie-icon { font-size: 48px; margin-bottom: 16px; }
        .insight-empty h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .insight-empty p { font-size: 14px; color: var(--text-2); max-width: 400px; margin: 0 auto 20px; line-height: 1.5; }
        .insight-empty button { background: var(--accent); color: #fff; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; font-family: 'Sora', sans-serif; }
        .reflecting-spinner { display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
            .stats-strip { grid-template-columns: repeat(2, 1fr); }
            .entities-grid { grid-template-columns: 1fr; }
            .insight-grid { grid-template-columns: 1fr; }
            .search-bar { width: 100%; }
        }
    </style>
</head>
<body>

<div class="login-screen" id="login-screen">
    <div class="login-box">
        <h1><svg width="28" height="28" viewBox="0 0 120 120" style="vertical-align:middle;margin-right:4px;"><path d="M60 16 Q92 16 96 48 Q100 78 72 88 Q50 96 38 76 Q26 58 46 46 Q62 38 70 52 Q76 64 62 68" fill="none" stroke="#a855f7" stroke-width="8" stroke-linecap="round"/><circle cx="62" cy="68" r="8" fill="#a855f7"/><circle cx="62" cy="68" r="3.5" fill="#fff"/></svg> Mengram</h1>
        <p>Enter your API key to access your memory dashboard.</p>
        <input type="password" class="login-input" id="key-input" placeholder="om-..." autocomplete="off">
        <button class="login-btn" onclick="doLogin()">Open Dashboard</button>
        <div class="login-error" id="login-error">Invalid API key. Check and try again.</div>
        <div class="login-links">Don't have a key? <a href="/">Sign up free ‚Üí</a></div>
    </div>
</div>

<div class="app" id="app">
    <div class="sidebar">
        <div class="sidebar-logo"><svg width="20" height="20" viewBox="0 0 120 120" style="vertical-align:middle;margin-right:4px;"><path d="M60 16 Q92 16 96 48 Q100 78 72 88 Q50 96 38 76 Q26 58 46 46 Q62 38 70 52 Q76 64 62 68" fill="none" stroke="#a855f7" stroke-width="8" stroke-linecap="round"/><circle cx="62" cy="68" r="8" fill="#a855f7"/><circle cx="62" cy="68" r="3.5" fill="#fff"/></svg> Mengram</div>
        <div class="sidebar-nav">
            <div class="nav-item active" onclick="switchTab('feed')"><span class="icon">üìã</span> Memory Feed</div>
            <div class="nav-item" onclick="switchTab('agents')"><span class="icon">ü§ñ</span> Agents</div>
            <div class="nav-item" onclick="switchTab('insights')"><span class="icon">‚ú®</span> AI Insights</div>
            <div class="nav-item" onclick="switchTab('graph')"><span class="icon">üï∏Ô∏è</span> Knowledge Graph</div>
            <div class="nav-item" onclick="switchTab('entities')"><span class="icon">üì¶</span> Entities</div>
            <div class="nav-item" onclick="switchTab('procedures')"><span class="icon">üß¨</span> Procedures</div>
            <div class="nav-item" onclick="switchTab('settings')"><span class="icon">‚öôÔ∏è</span> Settings</div>
        </div>
        <div class="sidebar-footer"><a href="/">‚Üê Home</a></div>
    </div>

    <div class="main">
        <div class="stats-strip">
            <div class="stat-card"><div class="stat-label">Entities</div><div class="stat-value purple" id="s-ent">‚Äî</div></div>
            <div class="stat-card"><div class="stat-label">Facts</div><div class="stat-value green" id="s-facts">‚Äî</div></div>
            <div class="stat-card"><div class="stat-label">Relations</div><div class="stat-value blue" id="s-rels">‚Äî</div></div>
            <div class="stat-card"><div class="stat-label">Knowledge</div><div class="stat-value orange" id="s-know">‚Äî</div></div>
        </div>

        <div class="tab-content active" id="tab-feed">
            <div class="page-header">
                <h2>Memory Feed</h2>
                <div class="search-bar"><span>üîç</span><input id="search-input" placeholder="Semantic search..." onkeydown="if(event.key==='Enter')doSearch()"><div class="search-dropdown" id="search-dd"></div></div>
            </div>
            <div id="feed-box" class="loading">Loading memories...</div>
        </div>

        <div class="tab-content" id="tab-agents">
            <div class="page-header">
                <h2>ü§ñ Memory Agents</h2>
                <div style="display:flex;gap:8px;">
                    <button onclick="runAgent('curator')" style="background:var(--green);color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;">üßπ Curator</button>
                    <button onclick="runAgent('connector')" style="background:var(--blue);color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;">üîó Connector</button>
                    <button onclick="runAgent('digest')" style="background:var(--orange);color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;">üì∞ Digest</button>
                    <button onclick="runAgent('all')" style="background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;">üöÄ Run All</button>
                </div>
            </div>
            <div id="agents-box">
                <div class="agents-intro" style="text-align:center;padding:40px 20px;color:var(--text-2);">
                    <div style="font-size:48px;margin-bottom:16px;">ü§ñ</div>
                    <h3 style="color:var(--text);margin-bottom:8px;">Memory Agents</h3>
                    <p>Autonomous agents that clean, analyze, and generate insights from your memory.</p>
                    <div style="display:flex;gap:20px;justify-content:center;margin-top:24px;flex-wrap:wrap;">
                        <div style="background:var(--bg-card);border-radius:12px;padding:16px;width:180px;text-align:left;">
                            <div style="font-size:24px;margin-bottom:8px;">üßπ</div>
                            <strong style="color:var(--green);">Curator</strong>
                            <p style="font-size:12px;margin-top:4px;">Finds contradictions, stale facts, duplicates. Auto-cleans memory.</p>
                        </div>
                        <div style="background:var(--bg-card);border-radius:12px;padding:16px;width:180px;text-align:left;">
                            <div style="font-size:24px;margin-bottom:8px;">üîó</div>
                            <strong style="color:var(--blue);">Connector</strong>
                            <p style="font-size:12px;margin-top:4px;">Discovers hidden patterns, skill clusters, strategic insights.</p>
                        </div>
                        <div style="background:var(--bg-card);border-radius:12px;padding:16px;width:180px;text-align:left;">
                            <div style="font-size:24px;margin-bottom:8px;">üì∞</div>
                            <strong style="color:var(--orange);">Digest</strong>
                            <p style="font-size:12px;margin-top:4px;">Weekly summary of memory activity, trends, recommendations.</p>
                        </div>
                    </div>
                </div>
                <div id="agent-results" style="display:none;"></div>
                <div id="agent-history" style="margin-top:20px;"></div>
            </div>
        </div>

        <div class="tab-content" id="tab-insights">
            <div class="page-header">
                <h2>‚ú® AI Insights</h2>
                <button onclick="triggerReflection()" style="background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;">üîÑ Reflect Now</button>
            </div>
            <div id="insights-box" class="loading">Analyzing your memories...</div>
        </div>

        <div class="tab-content" id="tab-graph">
            <div class="page-header"><h2>Knowledge Graph</h2></div>
            <div class="graph-box" id="graph-box">
                <div class="graph-legend">
                    <span><span class="ldot" style="background:var(--blue)"></span>Person</span>
                    <span><span class="ldot" style="background:var(--accent)"></span>Project</span>
                    <span><span class="ldot" style="background:var(--green)"></span>Technology</span>
                    <span><span class="ldot" style="background:var(--orange)"></span>Company</span>
                    <span><span class="ldot" style="background:var(--pink)"></span>Concept</span>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab-entities">
            <div class="page-header"><h2>All Entities</h2></div>
            <div class="entities-grid" id="ent-grid"></div>
        </div>

        <div class="tab-content" id="tab-procedures">
            <div class="page-header"><h2>üß¨ Procedures</h2></div>
            <div id="procedures-box">
                <div class="loading" style="text-align:center;padding:40px;color:var(--text-2);">Loading procedures...</div>
            </div>
            <div id="procedure-detail" style="display:none;margin-top:20px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <button onclick="closeProcedureDetail()" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:6px 12px;color:var(--text-2);cursor:pointer;font-size:13px;">‚Üê Back</button>
                    <h3 id="proc-detail-name" style="font-size:18px;font-weight:600;"></h3>
                    <span id="proc-detail-version" style="background:var(--accent-dim);color:var(--accent);padding:2px 8px;border-radius:6px;font-size:12px;font-weight:500;"></span>
                </div>
                <div id="proc-detail-content"></div>
            </div>
        </div>

        <div class="tab-content" id="tab-settings">
            <div class="page-header"><h2>Settings</h2></div>
            <div class="set-section">
                <h3>üîî Webhooks</h3>
                <p>Get notified when memories are added, updated, or deleted.</p>
                <div id="webhooks-list" style="margin:12px 0;"></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;">
                    <div style="flex:1;min-width:200px;">
                        <label style="font-size:11px;color:var(--text-2);display:block;margin-bottom:4px;">Webhook URL</label>
                        <input id="wh-url" placeholder="https://webhook.site/..." style="width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
                    </div>
                    <div style="min-width:120px;">
                        <label style="font-size:11px;color:var(--text-2);display:block;margin-bottom:4px;">Name (optional)</label>
                        <input id="wh-name" placeholder="My Hook" style="width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
                    </div>
                    <button onclick="createWebhook()" style="padding:8px 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;">+ Add</button>
                </div>
            </div>
            <div class="set-section">
                <h3>ü§ù Teams ‚Äî Shared Memory</h3>
                <p>Share memories with your team. Everyone's AI sees the shared context.</p>
                <div id="teams-list" style="margin:12px 0;"></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;">
                    <div style="flex:1;min-width:150px;">
                        <label style="font-size:11px;color:var(--text-2);display:block;margin-bottom:4px;">Create new team</label>
                        <input id="team-name" placeholder="Team name" style="width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
                    </div>
                    <button onclick="createTeam()" style="padding:8px 16px;background:var(--green);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;">+ Create</button>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin-top:10px;">
                    <div style="flex:1;min-width:150px;">
                        <label style="font-size:11px;color:var(--text-2);display:block;margin-bottom:4px;">Join existing team</label>
                        <input id="invite-code" placeholder="Paste invite code" style="width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
                    </div>
                    <button onclick="joinTeam()" style="padding:8px 16px;background:var(--blue);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;">Join</button>
                </div>
            </div>
            <div class="set-section">
                <h3>üîë API Keys</h3>
                <p style="color:var(--text-2);font-size:13px;margin-bottom:12px;">Create multiple keys for different apps. Revoke any key without affecting others.</p>
                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <input id="new-key-name" placeholder="Key name (e.g. Claude Desktop)" style="flex:1;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
                    <button onclick="createNewKey()" style="padding:8px 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;white-space:nowrap;">+ New Key</button>
                </div>
                <div id="keys-list" style="margin-top:8px;"></div>
            </div>
            <div class="set-section">
                <h3>Data</h3>
                <p>Export or delete all your memory data.</p>
                <div style="display:flex;gap:10px;">
                    <button class="btn-s" onclick="exportData()">Export JSON</button>
                    <button class="btn-s btn-d" onclick="if(confirm('Delete ALL data? Cannot be undone.'))deleteAll()">Delete All</button>
                </div>
            </div>
            <div class="set-section">
                <h3>Links</h3>
                <div class="set-row"><label>Homepage</label><a href="/" style="color:var(--accent);text-decoration:none;font-size:14px;">mengram.io</a></div>
                <div class="set-row"><label>GitHub</label><a href="https://github.com/alibaizhanov/mengram" style="color:var(--accent);text-decoration:none;font-size:14px;">alibaizhanov/mengram</a></div>
                <div class="set-row"><label>PyPI</label><a href="https://pypi.org/project/mengram-ai/" style="color:var(--accent);text-decoration:none;font-size:14px;">mengram-ai</a></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-bg" id="modal-bg" onclick="if(event.target===this)closeModal()">
    <div class="modal" id="modal-body"></div>
</div>

<script>
const API = window.location.origin;
let KEY = '';
function H() { return { 'Authorization': `Bearer ${KEY}`, 'Content-Type': 'application/json' }; }
function esc(s) { if(!s)return ''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function escA(s) { return (s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

document.getElementById('key-input').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
const saved = localStorage.getItem('mengram_key');
if(saved) { KEY=saved; tryLogin(saved); }

async function doLogin() { await tryLogin(document.getElementById('key-input').value.trim()); }
async function tryLogin(k) {
    if(!k) return;
    try {
        const r = await fetch(`${API}/v1/stats`, { headers: {'Authorization':`Bearer ${k}`} });
        if(r.ok) {
            KEY=k; localStorage.setItem('mengram_key',k);
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app').classList.add('active');
            loadAll();
        } else { document.getElementById('login-error').style.display='block'; }
    } catch(e) { document.getElementById('login-error').style.display='block'; }
}

function switchTab(t) {
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    event.currentTarget.classList.add('active');
    if(t==='graph') loadGraph();
    if(t==='entities') loadEntities();
    if(t==='insights') loadInsights();
    if(t==='agents') loadAgentHistory();
    if(t==='procedures') loadProcedures();
    if(t==='settings') { loadWebhooks(); loadTeams(); loadKeys(); }
}

async function loadAll() { loadStats(); loadFeed(); }

// ---- Agents ----
let agentRunning = false;

async function runAgent(type) {
    if (agentRunning) return;
    agentRunning = true;
    const resultsBox = document.getElementById('agent-results');
    resultsBox.style.display = 'block';
    resultsBox.innerHTML = `<div class="loading" style="text-align:center;padding:30px;color:var(--text-2);"><div style="font-size:32px;margin-bottom:12px;">‚è≥</div>Running ${type === 'all' ? 'all agents' : type + ' agent'}... (10-30 sec)</div>`;

    try {
        const autoFix = type === 'curator' || type === 'all' ? '&auto_fix=true' : '';
        const res = await fetch(`${API}/v1/agents/run?agent=${type}${autoFix}`, {method:'POST', headers:H()});
        const data = await res.json();
        renderAgentResults(type, data);
        loadAgentHistory();
    } catch(e) {
        resultsBox.innerHTML = `<div style="color:var(--red);padding:20px;">Error: ${e.message}</div>`;
    }
    agentRunning = false;
}

function renderAgentResults(type, data) {
    const box = document.getElementById('agent-results');
    box.style.display = 'block';

    if (type === 'all' && data.agents) {
        let html = '<h3 style="margin-bottom:16px;">üöÄ All Agents Results</h3>';
        html += renderCuratorResult(data.agents.curator);
        html += renderConnectorResult(data.agents.connector);
        html += renderDigestResult(data.agents.digest);
        box.innerHTML = html;
    } else if (type === 'curator') {
        box.innerHTML = '<h3 style="margin-bottom:16px;">üßπ Curator Results</h3>' + renderCuratorResult(data.result);
    } else if (type === 'connector') {
        box.innerHTML = '<h3 style="margin-bottom:16px;">üîó Connector Results</h3>' + renderConnectorResult(data.result);
    } else if (type === 'digest') {
        box.innerHTML = '<h3 style="margin-bottom:16px;">üì∞ Digest</h3>' + renderDigestResult(data.result);
    }
}

function renderCuratorResult(r) {
    if (!r || r.status === 'error') return '<div style="color:var(--red)">Curator failed</div>';
    const meta = r._meta || {};
    let html = `<div style="background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border-left:3px solid var(--green);">`;
    html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">`;
    html += `<strong style="color:var(--green);">üßπ Curator</strong>`;
    html += `<span style="font-size:12px;color:var(--text-2);">Health: <strong style="color:${(r.health_score||0)>0.7?'var(--green)':'var(--orange)'}">${Math.round((r.health_score||0)*100)}%</strong></span>`;
    html += `</div>`;
    if (r.summary) html += `<p style="color:var(--text-2);font-size:13px;margin-bottom:12px;">${r.summary}</p>`;
    if (r.contradictions?.length) {
        html += `<div style="margin-bottom:8px;"><strong style="color:var(--red);font-size:12px;">‚ö†Ô∏è Contradictions (${r.contradictions.length})</strong>`;
        r.contradictions.forEach(c => {
            html += `<div style="font-size:12px;padding:6px 10px;margin:4px 0;background:rgba(255,50,50,0.1);border-radius:6px;">"${c.fact_a}" vs "${c.fact_b}" ‚Äî ${c.suggestion}</div>`;
        });
        html += `</div>`;
    }
    if (r.stale?.length) html += `<div style="font-size:12px;color:var(--orange);margin-top:4px;">üì¶ ${r.stale.length} stale facts found</div>`;
    if (r.low_quality?.length) html += `<div style="font-size:12px;color:var(--text-2);margin-top:4px;">üóëÔ∏è ${r.low_quality.length} low quality facts</div>`;
    if (meta.actions_taken) html += `<div style="font-size:12px;color:var(--green);margin-top:4px;">‚úÖ Auto-fixed: ${meta.actions_taken} facts archived</div>`;
    html += `</div>`;
    return html;
}

function renderConnectorResult(r) {
    if (!r || r.status === 'error') return '<div style="color:var(--red)">Connector failed</div>';
    let html = `<div style="background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border-left:3px solid var(--blue);">`;
    html += `<strong style="color:var(--blue);">üîó Connector</strong>`;
    if (r.connections?.length) {
        html += `<div style="margin-top:10px;"><strong style="font-size:12px;">Hidden Connections</strong>`;
        r.connections.forEach(c => {
            html += `<div style="font-size:12px;padding:6px 10px;margin:4px 0;background:rgba(100,100,255,0.1);border-radius:6px;"><strong>${c.entities?.join(' ‚Üî ')}</strong>: ${c.insight}</div>`;
        });
        html += `</div>`;
    }
    if (r.patterns?.length) {
        html += `<div style="margin-top:10px;"><strong style="font-size:12px;">Behavioral Patterns</strong>`;
        r.patterns.forEach(p => {
            html += `<div style="font-size:12px;padding:6px 10px;margin:4px 0;background:rgba(100,200,100,0.1);border-radius:6px;">${p.pattern} ‚Äî <em>${p.implication}</em></div>`;
        });
        html += `</div>`;
    }
    if (r.suggestions?.length) {
        html += `<div style="margin-top:10px;"><strong style="font-size:12px;">üí° Suggestions</strong>`;
        r.suggestions.forEach(s => {
            const pc = s.priority === 'high' ? 'var(--red)' : s.priority === 'medium' ? 'var(--orange)' : 'var(--text-2)';
            html += `<div style="font-size:12px;padding:6px 10px;margin:4px 0;background:rgba(255,200,50,0.1);border-radius:6px;"><span style="color:${pc};">[${s.priority}]</span> ${s.action}</div>`;
        });
        html += `</div>`;
    }
    html += `</div>`;
    return html;
}

function renderDigestResult(r) {
    if (!r || r.status === 'error') return '<div style="color:var(--red)">Digest failed</div>';
    let html = `<div style="background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border-left:3px solid var(--orange);">`;
    html += `<strong style="color:var(--orange);">üì∞ Weekly Digest</strong>`;
    if (r.headline) html += `<p style="font-size:15px;font-weight:600;color:var(--text);margin:8px 0;">${r.headline}</p>`;
    if (r.highlights?.length) {
        html += `<ul style="font-size:13px;color:var(--text-2);padding-left:20px;margin:8px 0;">`;
        r.highlights.forEach(h => { html += `<li style="margin:4px 0;">${h}</li>`; });
        html += `</ul>`;
    }
    if (r.recommendation) html += `<div style="font-size:13px;padding:10px;margin-top:8px;background:rgba(130,80,255,0.1);border-radius:8px;color:var(--accent);">üí° ${r.recommendation}</div>`;
    html += `</div>`;
    return html;
}

async function loadAgentHistory() {
    const box = document.getElementById('agent-history');
    try {
        const d = await (await fetch(`${API}/v1/agents/history?limit=5`, {headers:H()})).json();
        if (!d.runs?.length) { box.innerHTML = '<p style="color:var(--text-2);text-align:center;font-size:13px;">No agent runs yet. Click a button above to start.</p>'; return; }
        let html = '<h4 style="margin-bottom:8px;color:var(--text-2);font-size:13px;">Recent Runs</h4>';
        d.runs.forEach(r => {
            const icons = {curator:'üßπ',connector:'üîó',digest:'üì∞'};
            const time = new Date(r.created_at).toLocaleString();
            html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg-card);border-radius:8px;margin-bottom:4px;font-size:12px;">`;
            html += `<span>${icons[r.agent_type]||'ü§ñ'} <strong>${r.agent_type}</strong></span>`;
            html += `<span style="color:var(--text-2);">${r.issues_found} findings${r.actions_taken ? `, ${r.actions_taken} fixed` : ''}</span>`;
            html += `<span style="color:var(--text-2);">${time}</span>`;
            html += `</div>`;
        });
        box.innerHTML = html;
    } catch(e) { box.innerHTML = ''; }
}
async function loadInsights() {
    const box = document.getElementById('insights-box');
    try {
        const d = await (await fetch(`${API}/v1/insights`,{headers:H()})).json();
        if(!d.has_insights) {
            box.innerHTML = `<div class="insight-empty">
                <div class="ie-icon">‚ú®</div>
                <h3>No insights yet</h3>
                <p>Mengram needs enough memories to generate insights. Keep chatting with AI assistants, or click below to generate your first reflection.</p>
                <button onclick="triggerReflection()">‚ú® Generate Insights</button>
            </div>`;
            return;
        }
        let h = '<div class="insight-grid">';
        
        // Profile card
        if(d.profile) {
            h += insightCard('üìä', 'Profile', d.profile, 'full');
        }
        
        // Weekly card
        if(d.weekly) {
            h += insightCard('üîÑ', 'Recent Activity', d.weekly);
        }
        
        // Network card
        if(d.network) {
            h += insightCard('üë•', 'Network', d.network);
        }
        
        // Patterns card
        if(d.patterns) {
            h += insightCard('üí°', 'Patterns', d.patterns);
        }

        // All other reflections
        const shown = [d.profile, d.weekly, d.network, d.patterns].filter(Boolean).map(r=>r.title);
        const others = (d.all_reflections||[]).filter(r => !shown.includes(r.title));
        for(const r of others) {
            const icon = r.scope === 'entity' ? 'üì¶' : r.scope === 'cross' ? 'üîó' : '‚è±Ô∏è';
            h += insightCard(icon, r.title, r);
        }
        
        h += '</div>';
        box.innerHTML = h;
    } catch(e) {
        box.innerHTML = `<div class="insight-empty"><div class="ie-icon">‚ö†Ô∏è</div><h3>Error loading insights</h3><p>${e.message}</p></div>`;
    }
}

function insightCard(icon, label, r, cls) {
    const conf = Math.round((r.confidence||0.8)*100);
    const confColor = conf >= 80 ? 'var(--green)' : conf >= 60 ? 'var(--orange)' : 'var(--red)';
    const time = r.refreshed_at ? new Date(r.refreshed_at).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
    const scopeLabel = r.scope === 'entity' ? 'Entity' : r.scope === 'cross' ? 'Cross-entity' : r.scope === 'temporal' ? 'Temporal' : r.scope;
    return `<div class="insight-card ${cls||''}">
        <div class="ic-head">
            <span class="ic-icon">${icon}</span>
            <span class="ic-title">${label}</span>
            <span class="ic-scope">${scopeLabel}</span>
        </div>
        <div class="ic-body">${r.content}</div>
        <div class="ic-meta">
            <span class="ic-conf">
                Confidence: ${conf}%
                <span class="conf-bar"><span class="conf-fill" style="width:${conf}%;background:${confColor}"></span></span>
            </span>
            ${r.entity && r.entity !== '_reflections' ? `<span>üì¶ ${r.entity}</span>` : ''}
            ${time ? `<span>üïê ${time}</span>` : ''}
        </div>
    </div>`;
}

async function triggerReflection() {
    const box = document.getElementById('insights-box');
    box.innerHTML = '<div class="insight-empty"><div class="ie-icon"><span class="reflecting-spinner">‚ú®</span></div><h3>Reflecting...</h3><p>Analyzing your memories and generating insights. This may take 10-20 seconds.</p></div>';
    try {
        const d = await (await fetch(`${API}/v1/reflect`,{method:'POST',headers:H()})).json();
        const total = (d.generated.entity_reflections||0) + (d.generated.cross_entity||0) + (d.generated.temporal||0);
        if(total > 0) {
            await loadInsights();
        } else {
            box.innerHTML = '<div class="insight-empty"><div class="ie-icon">ü§î</div><h3>Not enough data</h3><p>Add more memories through conversations first.</p></div>';
        }
    } catch(e) {
        box.innerHTML = `<div class="insight-empty"><div class="ie-icon">‚ö†Ô∏è</div><h3>Reflection failed</h3><p>${e.message}</p></div>`;
    }
}

async function loadStats() {
    try {
        const d = await (await fetch(`${API}/v1/stats`,{headers:H()})).json();
        document.getElementById('s-ent').textContent = d.entities||0;
        document.getElementById('s-facts').textContent = d.facts||0;
        document.getElementById('s-rels').textContent = d.relations||0;
        document.getElementById('s-know').textContent = d.knowledge||0;
    } catch(e){}
}

// ---- Feed ----
async function loadFeed() {
    const box = document.getElementById('feed-box');
    box.innerHTML = `<div style="padding:16px;">${[1,2,3,4,5].map(()=>'<div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;"><div style="width:80px;height:24px;background:var(--bg-elevated);border-radius:6px;animation:pulse 1.5s infinite;"></div><div style="flex:1;height:16px;background:var(--bg-elevated);border-radius:4px;animation:pulse 1.5s infinite;"></div></div>').join('')}</div><style>@keyframes pulse{0%,100%{opacity:0.4}50%{opacity:0.8}}</style>`;
    try {
        const d = await (await fetch(`${API}/v1/feed?limit=100`,{headers:H()})).json();
        if(!d.feed||!d.feed.length) {
            box.innerHTML = `<div class="empty"><div class="eicon">üìã</div><h3>Your memory is empty</h3><p>Use <a href="/">Claude Desktop MCP</a> or the <a href="https://pypi.org/project/mengram-ai/">Python API</a> to start building your AI memory.</p></div>`;
            return;
        }
        let h='<div class="feed-list">',last='';
        for(const it of d.feed) {
            const dt = it.created_at ? new Date(it.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : 'Unknown';
            if(dt!==last) { h+=`<div class="feed-date">${dt}</div>`; last=dt; }
            const bc = 'b-'+(it.entity_type||'concept');
            const tm = it.created_at ? new Date(it.created_at).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}) : '';
            const imp = it.importance || 0.5;
            const impColor = imp >= 0.8 ? '#a855f7' : imp >= 0.6 ? '#6366f1' : imp >= 0.4 ? '#64748b' : '#334155';
            const impLabel = imp >= 0.8 ? '‚óè‚óè‚óè' : imp >= 0.6 ? '‚óè‚óè‚óã' : imp >= 0.4 ? '‚óè‚óã‚óã' : '‚óã‚óã‚óã';
            const accInfo = it.access_count > 0 ? ` ¬∑ recalled ${it.access_count}√ó` : '';
            h+=`<div class="feed-item">
                <span class="feed-badge ${bc}">${esc(it.entity)}</span>
                <div class="feed-content"><div class="feed-fact">${esc(it.fact)}</div><div class="feed-meta">${tm}<span style="color:${impColor};margin-left:8px" title="Importance: ${imp}">${impLabel}</span>${accInfo}</div></div>
                <button class="feed-del" onclick="archFact('${escA(it.id)}','${escA(it.entity)}','${escA(it.fact)}',this)" title="Delete">‚úï</button>
            </div>`;
        }
        h+='</div>';
        box.innerHTML=h;
    } catch(e) { box.innerHTML='<div class="empty"><p>Failed to load feed.</p></div>'; }
}

async function archFact(id,entity,fact,btn) {
    if(!confirm(`Delete: "${fact}"?`)) return;
    try {
        await fetch(`${API}/v1/archive_fact`,{method:'POST',headers:H(),body:JSON.stringify({entity_name:entity,fact_content:fact})});
        btn.closest('.feed-item').style.display='none';
        loadStats();
    } catch(e){}
}

// ---- Graph ----
async function loadGraph() {
    try {
        const d = await (await fetch(`${API}/v1/graph`,{headers:H()})).json();
        renderGraph(d);
    } catch(e){}
}

function renderGraph(data) {
    const box = document.getElementById('graph-box');
    box.querySelectorAll('svg').forEach(s=>s.remove());
    const W=box.clientWidth, HH=box.clientHeight;
    const tc = {person:'#60a5fa',project:'#a855f7',technology:'#34d399',company:'#fb923c',concept:'#f472b6'};
    const nodes = data.nodes.map(n=>({id:n.name,type:n.type,r:6+Math.min((n.facts_count||0)*1.5,18),c:tc[n.type]||'#888'}));
    const ns = new Set(nodes.map(n=>n.id));
    const links = data.edges.filter(e=>ns.has(e.source)&&ns.has(e.target)).map(e=>({source:e.source,target:e.target,type:e.type}));

    const svg = d3.select(box).append('svg').attr('width',W).attr('height',HH);
    const g = svg.append('g');

    // Zoom
    svg.call(d3.zoom().scaleExtent([0.3,4]).on('zoom', e => g.attr('transform', e.transform)));

    const sim = d3.forceSimulation(nodes)
        .force('link',d3.forceLink(links).id(d=>d.id).distance(90))
        .force('charge',d3.forceManyBody().strength(-250))
        .force('center',d3.forceCenter(W/2,HH/2))
        .force('collision',d3.forceCollide().radius(d=>d.r+6));

    const link = g.append('g').selectAll('line').data(links).join('line')
        .attr('stroke','#1a1a2e').attr('stroke-width',1.2);

    const node = g.append('g').selectAll('g').data(nodes).join('g')
        .call(d3.drag()
            .on('start',(e,d)=>{if(!e.active)sim.alphaTarget(0.3).restart();d.fx=d.x;d.fy=d.y;})
            .on('drag',(e,d)=>{d.fx=e.x;d.fy=e.y;})
            .on('end',(e,d)=>{if(!e.active)sim.alphaTarget(0);d.fx=null;d.fy=null;}));

    node.append('circle').attr('r',d=>d.r).attr('fill',d=>d.c).attr('fill-opacity',0.15)
        .attr('stroke',d=>d.c).attr('stroke-width',1.5).style('cursor','pointer')
        .on('click',(e,d)=>openEntity(d.id));

    // Glow on hover
    node.on('mouseenter', function(e,d) { d3.select(this).select('circle').attr('fill-opacity',0.35).attr('stroke-width',2.5); })
        .on('mouseleave', function(e,d) { d3.select(this).select('circle').attr('fill-opacity',0.15).attr('stroke-width',1.5); });

    node.append('text').text(d=>d.id).attr('dy',d=>d.r+14).attr('text-anchor','middle')
        .attr('fill','#9898b0').attr('font-size','11px').attr('font-family','Sora,sans-serif');

    sim.on('tick',()=>{
        link.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
        node.attr('transform',d=>`translate(${d.x},${d.y})`);
    });
}

// ---- Entities ----
async function loadEntities() {
    const grid = document.getElementById('ent-grid');
    try {
        const d = await (await fetch(`${API}/v1/memories`,{headers:H()})).json();
        const ents = d.memories||[];
        if(!ents.length) { grid.innerHTML='<div class="empty"><div class="eicon">üì¶</div><h3>No entities yet</h3></div>'; return; }
        grid.innerHTML = ents.map(e=>{
            const bc='b-'+(e.type||'concept');
            const facts = (e.facts||[]).slice(0,3).join(' ¬∑ ');
            return `<div class="e-card" onclick="openEntity('${escA(e.name)}')">
                <div class="e-head"><span class="e-name">${esc(e.name)}</span><span class="e-tag ${bc}">${e.type}</span></div>
                <div class="e-facts">${esc(facts)||'No facts yet'}</div>
                <div class="e-count">${e.facts_count||e.facts?.length||0} facts</div>
            </div>`;
        }).join('');
    } catch(e) { grid.innerHTML='<div class="empty"><p>Failed to load.</p></div>'; }
}

// ---- Modal ----
async function openEntity(name) {
    const bg=document.getElementById('modal-bg'), body=document.getElementById('modal-body');
    body.innerHTML='<div class="loading">Loading...</div>'; bg.classList.add('show');
    try {
        const d = await (await fetch(`${API}/v1/memory/${encodeURIComponent(name)}`,{headers:H()})).json();
        let h=`<div class="modal-head"><h2>${esc(d.entity)} <span class="e-tag b-${d.type}" style="font-size:12px;margin-left:8px">${d.type}</span></h2><button class="modal-x" onclick="closeModal()">‚úï</button></div>`;
        if(d.facts?.length) {
            h+='<div class="modal-sec"><h3>Facts</h3>';
            for(const f of d.facts) h+=`<div class="m-fact"><span>${esc(f)}</span><button onclick="archFactM('${escA(name)}','${escA(f)}',this)">‚úï</button></div>`;
            h+='</div>';
        }
        if(d.relations?.length) {
            h+='<div class="modal-sec"><h3>Relations</h3>';
            for(const r of d.relations) h+=`<div class="m-rel">${r.type} ${r.direction==='outgoing'?'‚Üí':'‚Üê'} <span>${esc(r.target)}</span></div>`;
            h+='</div>';
        }
        if(d.knowledge?.length) {
            h+='<div class="modal-sec"><h3>Knowledge</h3>';
            for(const k of d.knowledge) h+=`<div class="m-know"><span class="kt">${k.type}</span><div class="ktitle">${esc(k.title)}</div><div class="kcontent">${esc(k.content)}</div>${k.artifact?`<pre>${esc(k.artifact)}</pre>`:''}</div>`;
            h+='</div>';
        }
        h+=`<div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;">`;
        h+=`<button class="m-delete" style="flex:1;" onclick="delEntity('${escA(name)}')">üóëÔ∏è Delete "${esc(name)}"</button>`;
        h+=`<button style="flex:1;padding:10px;background:var(--green-dim);color:var(--green);border:1px solid var(--green);border-radius:8px;cursor:pointer;font-size:13px;" onclick="shareEntityDialog('${escA(name)}')">ü§ù Share to Team</button>`;
        h+=`</div>`;
        body.innerHTML=h;
    } catch(e) { body.innerHTML='<p style="color:var(--red)">Failed to load.</p>'; }
}
function closeModal() { document.getElementById('modal-bg').classList.remove('show'); }
async function archFactM(entity,fact,btn) {
    try { await fetch(`${API}/v1/archive_fact`,{method:'POST',headers:H(),body:JSON.stringify({entity_name:entity,fact_content:fact})}); btn.closest('.m-fact').style.display='none'; loadStats(); } catch(e){}
}
async function delEntity(name) {
    if(!confirm(`Delete "${name}" and ALL its data?`)) return;
    try { await fetch(`${API}/v1/entity/${encodeURIComponent(name)}`,{method:'DELETE',headers:H()}); closeModal(); loadAll(); } catch(e){}
}
async function shareEntityDialog(name) {
    try {
        const d = await (await fetch(`${API}/v1/teams`,{headers:H()})).json();
        if (!d.teams?.length) { alert('No teams yet. Create a team in Settings first.'); return; }
        const teamNames = d.teams.map((t,i) => `${i+1}. ${t.name}`).join('\n');
        const choice = prompt(`Share "${name}" to which team?\n\n${teamNames}\n\nEnter number:`);
        if (!choice) return;
        const idx = parseInt(choice) - 1;
        if (idx < 0 || idx >= d.teams.length) { alert('Invalid choice'); return; }
        const team = d.teams[idx];
        const r = await fetch(`${API}/v1/teams/${team.id}/share`, {method:'POST', headers:H(), body:JSON.stringify({entity:name})});
        if (r.ok) { alert(`‚úÖ "${name}" shared with ${team.name}!`); }
        else { const err = await r.json(); alert(err.detail || 'Failed to share'); }
    } catch(e) { alert('Error: ' + e.message); }
}

// ---- Search ----
let sTimer;
document.getElementById('search-input')?.addEventListener('input', e=>{
    clearTimeout(sTimer);
    const q=e.target.value.trim();
    if(q.length<2){document.getElementById('search-dd').classList.remove('show');return;}
    sTimer=setTimeout(()=>doSearch(q),400);
});
async function doSearch(q) {
    if(!q) q=document.getElementById('search-input').value.trim();
    if(!q) return;
    const dd=document.getElementById('search-dd');
    try {
        const d = await (await fetch(`${API}/v1/search`,{method:'POST',headers:H(),body:JSON.stringify({query:q,limit:5})})).json();
        if(d.results?.length) {
            dd.innerHTML=d.results.map(r=>{
                const fs=(r.facts||[]).slice(0,2).join(' ¬∑ ');
                const teamBadge = r.team_shared ? '<span style="background:var(--green-dim);color:var(--green);padding:1px 5px;border-radius:3px;font-size:10px;margin-left:4px;">team</span>' : '';
                return `<div class="search-item" onclick="openEntity('${escA(r.entity)}')"><div class="sname">${esc(r.entity)} <small style="color:var(--text-3)">${r.type}</small>${teamBadge}</div><div class="sfact">${esc(fs)}</div></div>`;
            }).join('');
        } else { dd.innerHTML='<div style="padding:14px;color:var(--text-3);font-size:13px;text-align:center">No results</div>'; }
        dd.classList.add('show');
    } catch(e){}
}
document.addEventListener('click',e=>{if(!e.target.closest('.search-bar'))document.getElementById('search-dd')?.classList.remove('show');});

// ---- Settings ----
async function loadWebhooks() {
    const box = document.getElementById('webhooks-list');
    try {
        const d = await (await fetch(`${API}/v1/webhooks`, {headers:H()})).json();
        if (!d.webhooks?.length) {
            box.innerHTML = '<p style="color:var(--text-2);font-size:13px;">No webhooks configured. Add one above.</p>';
            return;
        }
        let html = '';
        d.webhooks.forEach(w => {
            const events = (w.event_types||[]).map(e => `<span style="background:var(--accent-dim);color:var(--accent);padding:2px 6px;border-radius:4px;font-size:11px;">${e}</span>`).join(' ');
            const status = w.active ? '<span style="color:var(--green);">‚óè</span>' : '<span style="color:var(--text-2);">‚óã</span>';
            const lastTriggered = w.last_triggered ? new Date(w.last_triggered).toLocaleString() : 'never';
            const error = w.last_error ? `<div style="color:var(--red);font-size:11px;margin-top:4px;">Last error: ${esc(w.last_error).substring(0,80)}</div>` : '';
            html += `<div style="background:var(--bg-card);border-radius:10px;padding:12px;margin-bottom:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        ${status} <strong style="font-size:13px;">${esc(w.name) || 'Unnamed'}</strong>
                        <span style="font-size:11px;color:var(--text-2);margin-left:8px;">${esc(w.url).substring(0,50)}${w.url.length>50?'...':''}</span>
                    </div>
                    <div style="display:flex;gap:6px;">
                        <button onclick="toggleWebhook(${w.id},${!w.active})" style="padding:4px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text-2);cursor:pointer;font-size:11px;">${w.active?'Disable':'Enable'}</button>
                        <button onclick="if(confirm('Delete this webhook?'))deleteWebhook(${w.id})" style="padding:4px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--red);cursor:pointer;font-size:11px;">Delete</button>
                    </div>
                </div>
                <div style="margin-top:6px;">${events}</div>
                <div style="font-size:11px;color:var(--text-2);margin-top:4px;">Triggered ${w.trigger_count}x ¬∑ Last: ${lastTriggered}</div>
                ${error}
            </div>`;
        });
        box.innerHTML = html;
    } catch(e) {
        box.innerHTML = '<p style="color:var(--red);font-size:13px;">Failed to load webhooks.</p>';
    }
}

async function createWebhook() {
    const url = document.getElementById('wh-url').value.trim();
    const name = document.getElementById('wh-name').value.trim();
    if (!url) { alert('URL is required'); return; }
    try {
        const r = await fetch(`${API}/v1/webhooks`, {
            method:'POST', headers:H(),
            body: JSON.stringify({url, name, event_types:["memory_add","memory_update","memory_delete"]})
        });
        const d = await r.json();
        if (r.ok) {
            document.getElementById('wh-url').value = '';
            document.getElementById('wh-name').value = '';
            loadWebhooks();
        } else {
            alert(d.detail || 'Failed to create webhook');
        }
    } catch(e) { alert('Error: ' + e.message); }
}

async function toggleWebhook(id, active) {
    try {
        await fetch(`${API}/v1/webhooks/${id}`, {method:'PUT', headers:H(), body: JSON.stringify({active})});
        loadWebhooks();
    } catch(e) { alert('Failed'); }
}

async function deleteWebhook(id) {
    try {
        await fetch(`${API}/v1/webhooks/${id}`, {method:'DELETE', headers:H()});
        loadWebhooks();
    } catch(e) { alert('Failed'); }
}

// ---- Teams ----
async function loadTeams() {
    const box = document.getElementById('teams-list');
    try {
        const d = await (await fetch(`${API}/v1/teams`, {headers:H()})).json();
        if (!d.teams?.length) {
            box.innerHTML = '<p style="color:var(--text-2);font-size:13px;">No teams yet. Create one or join with an invite code.</p>';
            return;
        }
        let html = '';
        d.teams.forEach(t => {
            const isOwner = t.role === 'owner';
            html += `<div style="background:var(--bg-card);border-radius:10px;padding:12px;margin-bottom:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <strong style="font-size:14px;">${esc(t.name)}</strong>
                        <span style="font-size:11px;padding:2px 6px;border-radius:4px;margin-left:6px;background:${isOwner?'var(--accent-dim)':'rgba(100,200,100,0.15)'};color:${isOwner?'var(--accent)':'var(--green)'};">${t.role}</span>
                    </div>
                    <div style="display:flex;gap:6px;">
                        ${isOwner ? `<button onclick="if(confirm('Delete team?'))deleteTeam(${t.id})" style="padding:4px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--red);cursor:pointer;font-size:11px;">Delete</button>` : 
                        `<button onclick="if(confirm('Leave team?'))leaveTeam(${t.id})" style="padding:4px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text-2);cursor:pointer;font-size:11px;">Leave</button>`}
                    </div>
                </div>
                <div style="font-size:12px;color:var(--text-2);margin-top:6px;">
                    üë• ${t.member_count} members ¬∑ üì¶ ${t.shared_memories} shared memories
                    ${t.invite_code ? ` ¬∑ <span style="cursor:pointer;color:var(--accent);" onclick="copyInvite('${t.invite_code}')" title="Click to copy">üîó ${t.invite_code}</span>` : ''}
                </div>
            </div>`;
        });
        box.innerHTML = html;
    } catch(e) {
        box.innerHTML = '<p style="color:var(--red);font-size:13px;">Failed to load teams.</p>';
    }
}

function copyInvite(code) {
    navigator.clipboard.writeText(code);
    alert('Invite code copied: ' + code + '\nShare it with your team!');
}

async function createTeam() {
    const name = document.getElementById('team-name').value.trim();
    if (!name) { alert('Team name is required'); return; }
    try {
        const r = await fetch(`${API}/v1/teams`, {method:'POST', headers:H(), body: JSON.stringify({name})});
        const d = await r.json();
        if (r.ok) {
            document.getElementById('team-name').value = '';
            loadTeams();
            alert(`Team created! Invite code: ${d.team?.invite_code}\nShare it with your team.`);
        } else { alert(d.detail || 'Failed'); }
    } catch(e) { alert('Error: ' + e.message); }
}

async function joinTeam() {
    const code = document.getElementById('invite-code').value.trim();
    if (!code) { alert('Invite code is required'); return; }
    try {
        const r = await fetch(`${API}/v1/teams/join`, {method:'POST', headers:H(), body: JSON.stringify({invite_code: code})});
        const d = await r.json();
        if (r.ok) {
            document.getElementById('invite-code').value = '';
            loadTeams();
            alert(`Joined team: ${d.team_name}!`);
        } else { alert(d.detail || 'Failed'); }
    } catch(e) { alert('Error: ' + e.message); }
}

async function deleteTeam(id) {
    try { await fetch(`${API}/v1/teams/${id}`, {method:'DELETE', headers:H()}); loadTeams(); } catch(e) { alert('Failed'); }
}

async function leaveTeam(id) {
    try { await fetch(`${API}/v1/teams/${id}/leave`, {method:'POST', headers:H()}); loadTeams(); } catch(e) { alert('Failed'); }
}

async function resetKey() {
    if(!confirm('Reset API key? All current keys stop working.')) return;
    try {
        const d = await (await fetch(`${API}/v1/reset-key`,{method:'POST',headers:H()})).json();
        if(d.api_key) { KEY=d.api_key; localStorage.setItem('mengram_key',d.api_key); alert('New key: '+d.api_key+'\n\nSave it!'); }
    } catch(e) { alert('Failed.'); }
}

async function loadKeys() {
    const box = document.getElementById('keys-list');
    try {
        const d = await (await fetch(`${API}/v1/keys`, {headers:H()})).json();
        if (!d.keys?.length) {
            box.innerHTML = '<p style="color:var(--text-2);font-size:13px;">No API keys.</p>';
            return;
        }
        box.innerHTML = d.keys.map(k => {
            const status = k.active
                ? '<span style="color:var(--green);">‚óè active</span>'
                : '<span style="color:var(--text-3);">‚óã revoked</span>';
            const lastUsed = k.last_used ? 'Used ' + new Date(k.last_used).toLocaleDateString() : 'Never used';
            const actions = k.active
                ? `<button onclick="if(confirm('Revoke key ${esc(k.prefix)}...?'))revokeKey(${k.id})" style="padding:3px 10px;background:none;border:1px solid var(--border);border-radius:6px;color:var(--red);cursor:pointer;font-size:11px;">Revoke</button>`
                : '';
            return `<div style="background:var(--bg-card);border-radius:10px;padding:10px 14px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;">
                <div>
                    <strong style="font-size:13px;">${esc(k.name)}</strong>
                    <span style="font-size:12px;color:var(--text-3);margin-left:8px;">${esc(k.prefix)}...</span>
                    <span style="font-size:11px;margin-left:8px;">${status}</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:11px;color:var(--text-3);">${lastUsed}</span>
                    ${actions}
                </div>
            </div>`;
        }).join('');
    } catch(e) { box.innerHTML = '<p style="color:var(--red);">Failed to load keys.</p>'; }
}

async function createNewKey() {
    const name = document.getElementById('new-key-name').value.trim() || 'default';
    try {
        const d = await (await fetch(`${API}/v1/keys`, {
            method: 'POST', headers: H(),
            body: JSON.stringify({name})
        })).json();
        if (d.key) {
            alert('New API key created!\n\n' + d.key + '\n\nSave this ‚Äî it will not be shown again.');
            document.getElementById('new-key-name').value = '';
            loadKeys();
        } else {
            alert(d.detail || 'Failed to create key');
        }
    } catch(e) { alert('Failed to create key.'); }
}

async function revokeKey(keyId) {
    try {
        const r = await fetch(`${API}/v1/keys/${keyId}`, {method:'DELETE', headers:H()});
        const d = await r.json();
        if (r.ok) { loadKeys(); }
        else { alert(d.detail || 'Failed to revoke'); }
    } catch(e) { alert('Failed.'); }
}
async function exportData() {
    try {
        const d = await (await fetch(`${API}/v1/memories/full`,{headers:H()})).json();
        const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='mengram-export.json'; a.click();
    } catch(e) { alert('Export failed.'); }
}
async function deleteAll() {
    try {
        const d = await (await fetch(`${API}/v1/memories`,{headers:H()})).json();
        for(const e of (d.memories||[])) await fetch(`${API}/v1/entity/${encodeURIComponent(e.name)}`,{method:'DELETE',headers:H()});
        loadAll(); alert('All data deleted.');
    } catch(e) { alert('Failed.'); }
}

// ---- Procedures ----
async function loadProcedures() {
    const box = document.getElementById('procedures-box');
    document.getElementById('procedure-detail').style.display = 'none';
    box.style.display = 'block';
    try {
        const res = await fetch(`${API}/v1/procedures`, {headers: H()});
        const data = await res.json();
        const procs = data.procedures || [];
        if (!procs.length) {
            box.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-2);">
                <div style="font-size:48px;margin-bottom:16px;">üß¨</div>
                <h3 style="color:var(--text);margin-bottom:8px;">No procedures yet</h3>
                <p>Procedures are auto-extracted from conversations. They capture workflows, processes, and how-to knowledge.</p>
                <p style="margin-top:8px;font-size:12px;">Add conversations via the API and procedures will appear here.</p>
            </div>`;
            return;
        }
        let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
        for (const p of procs) {
            const steps = (p.steps || []).length;
            const v = p.version || 1;
            const vBadge = v > 1 ? `<span style="background:var(--green-dim);color:var(--green);padding:2px 6px;border-radius:4px;font-size:11px;font-weight:500;">v${v}</span>` : '';
            const success = p.success_count || 0;
            const fail = p.failure_count || 0;
            html += `<div onclick="showProcedureDetail('${p.id}')" style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <strong style="font-size:15px;">${p.name}</strong> ${vBadge}
                </div>
                <div style="color:var(--text-2);font-size:13px;margin-bottom:8px;">${p.trigger || ''}</div>
                <div style="display:flex;gap:16px;font-size:12px;color:var(--text-3);">
                    <span>üìã ${steps} steps</span>
                    <span style="color:var(--green);">‚úÖ ${success} success</span>
                    <span style="color:var(--red);">‚ùå ${fail} fail</span>
                </div>
            </div>`;
        }
        html += '</div>';
        box.innerHTML = html;
    } catch(e) {
        box.innerHTML = `<div style="color:var(--red);padding:20px;">Failed to load procedures: ${e.message}</div>`;
    }
}

async function showProcedureDetail(id) {
    document.getElementById('procedures-box').style.display = 'none';
    const detail = document.getElementById('procedure-detail');
    detail.style.display = 'block';
    const content = document.getElementById('proc-detail-content');
    content.innerHTML = '<div class="loading" style="padding:20px;color:var(--text-2);">Loading...</div>';

    try {
        const res = await fetch(`${API}/v1/procedures/${id}/history`, {headers: H()});
        const data = await res.json();
        const versions = data.versions || [];
        const evolution = data.evolution_log || [];
        const current = versions.find(v => v.is_current) || versions[0];
        if (!current) { content.innerHTML = '<p style="color:var(--text-2);">Procedure not found.</p>'; return; }

        document.getElementById('proc-detail-name').textContent = current.name;
        document.getElementById('proc-detail-version').textContent = `v${current.version || 1}`;

        let html = '';

        // Current steps
        html += `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;">
            <h4 style="margin-bottom:4px;">Trigger</h4>
            <p style="color:var(--text-2);font-size:13px;margin-bottom:16px;">${current.trigger || 'N/A'}</p>
            <h4 style="margin-bottom:8px;">Steps</h4>
            <ol style="padding-left:20px;color:var(--text-2);font-size:13px;line-height:1.8;">`;
        for (const step of (current.steps || [])) {
            if (typeof step === 'object') {
                const action = esc(step.action || step.description || step.text || JSON.stringify(step));
                const detail = step.detail ? ` <span style="color:var(--text-3);">‚Äî ${esc(step.detail)}</span>` : '';
                html += `<li>${action}${detail}</li>`;
            } else {
                html += `<li>${esc(step)}</li>`;
            }
        }
        html += `</ol>
            <div style="display:flex;gap:16px;margin-top:16px;font-size:12px;color:var(--text-3);">
                <span style="color:var(--green);">‚úÖ ${current.success_count || 0} successes</span>
                <span style="color:var(--red);">‚ùå ${current.failure_count || 0} failures</span>
            </div>
        </div>`;

        // Evolution log
        if (evolution.length > 0) {
            html += `<h4 style="margin-bottom:12px;">üß¨ Evolution History</h4>
            <div style="display:flex;flex-direction:column;gap:8px;">`;
            for (const ev of evolution) {
                const typeColors = {step_added:'var(--green)',step_removed:'var(--red)',step_modified:'var(--orange)',auto_created:'var(--accent)'};
                const color = typeColors[ev.change_type] || 'var(--text-2)';
                const diff = ev.diff || {};
                html += `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="background:${color}22;color:${color};padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">${ev.change_type}</span>
                        <span style="color:var(--text-3);font-size:11px;">v${ev.version_before || '?'} ‚Üí v${ev.version_after || '?'}</span>
                        <span style="color:var(--text-3);font-size:11px;margin-left:auto;">${new Date(ev.created_at).toLocaleDateString()}</span>
                    </div>
                    ${diff.reason ? `<p style="color:var(--text-2);font-size:12px;">${diff.reason}</p>` : ''}
                </div>`;
            }
            html += '</div>';
        }

        // Version history
        if (versions.length > 1) {
            html += `<h4 style="margin-top:20px;margin-bottom:12px;">üìã All Versions</h4>
            <div style="display:flex;flex-direction:column;gap:6px;">`;
            for (const v of versions) {
                const isCurrent = v.is_current ? ' style="border-color:var(--accent);"' : '';
                const badge = v.is_current ? '<span style="background:var(--accent-dim);color:var(--accent);padding:1px 6px;border-radius:4px;font-size:10px;margin-left:6px;">current</span>' : '';
                html += `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:13px;"${isCurrent}>
                    <strong>v${v.version || 1}</strong>${badge}
                    <span style="color:var(--text-3);font-size:11px;margin-left:8px;">${(v.steps||[]).length} steps</span>
                </div>`;
            }
            html += '</div>';
        }

        content.innerHTML = html;
    } catch(e) {
        content.innerHTML = `<div style="color:var(--red);padding:20px;">Failed to load: ${e.message}</div>`;
    }
}

function closeProcedureDetail() {
    document.getElementById('procedure-detail').style.display = 'none';
    document.getElementById('procedures-box').style.display = 'block';
}
</script>
</body>
</html>
